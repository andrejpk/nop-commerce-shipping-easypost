name: Build and Package Plugin

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        path: plugin

    - name: Checkout nopCommerce
      uses: actions/checkout@v4
      with:
        repository: nopSolutions/nopCommerce
        ref: master
        path: nopCommerce

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore nopCommerce dependencies
      run: dotnet restore nopCommerce/src/NopCommerce.sln

    - name: Restore plugin dependencies
      run: dotnet restore plugin/src/Plugins/Nop.Plugin.Shipping.EasyPost/Nop.Plugin.Shipping.EasyPost.csproj

    - name: Build plugin
      run: dotnet build plugin/src/Plugins/Nop.Plugin.Shipping.EasyPost/Nop.Plugin.Shipping.EasyPost.csproj --configuration Release --no-restore

    - name: Run tests
      run: dotnet test plugin/src/Tests/Nop.Plugin.Shipping.EasyPost.Tests/Nop.Plugin.Shipping.EasyPost.Tests.csproj --configuration Release --verbosity normal

    - name: Prepare plugin package
      run: |
        mkdir -p package/Shipping.EasyPost

        # Copy plugin DLL and dependencies from nopCommerce output
        cp nopCommerce/src/Presentation/Nop.Web/Plugins/Shipping.EasyPost/Nop.Plugin.Shipping.EasyPost.dll package/Shipping.EasyPost/
        cp nopCommerce/src/Presentation/Nop.Web/Plugins/Shipping.EasyPost/Nop.Plugin.Shipping.EasyPost.pdb package/Shipping.EasyPost/ || true

        # Copy EasyPost dependency
        cp nopCommerce/src/Presentation/Nop.Web/Plugins/Shipping.EasyPost/EasyPost*.dll package/Shipping.EasyPost/ || true

        # Copy views
        cp -r plugin/src/Plugins/Nop.Plugin.Shipping.EasyPost/Views package/Shipping.EasyPost/

        # Copy plugin.json
        cp plugin/src/Plugins/Nop.Plugin.Shipping.EasyPost/plugin.json package/Shipping.EasyPost/

        # Copy logo if it exists
        if [ -f plugin/src/Plugins/Nop.Plugin.Shipping.EasyPost/logo.png ]; then
          cp plugin/src/Plugins/Nop.Plugin.Shipping.EasyPost/logo.png package/Shipping.EasyPost/
        fi

    - name: Create ZIP package
      run: |
        cd package
        zip -r ../Nop.Plugin.Shipping.EasyPost.zip Shipping.EasyPost/
        cd ..

    - name: Upload plugin package
      uses: actions/upload-artifact@v4
      with:
        name: Nop.Plugin.Shipping.EasyPost
        path: Nop.Plugin.Shipping.EasyPost.zip
        retention-days: 30

    - name: Get version from plugin.json
      id: get_version
      run: |
        VERSION=$(grep -o '"Version"[[:space:]]*:[[:space:]]*"[^"]*"' plugin/src/Plugins/Nop.Plugin.Shipping.EasyPost/plugin.json | sed 's/.*"\([^"]*\)".*/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Create Release on tag
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: Nop.Plugin.Shipping.EasyPost.zip
        body: |
          ## EasyPost Shipping Plugin v${{ steps.get_version.outputs.version }}

          Compatible with nopCommerce 4.90

          ### Installation
          1. Download the ZIP file
          2. Go to Admin → Configuration → Local plugins
          3. Click "Upload plugin or theme"
          4. Select the ZIP file
          5. Click "Upload plugin or theme" button
          6. Restart the application
          7. Click "Install" next to the plugin

          ### Changes
          See commit history for detailed changes.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
